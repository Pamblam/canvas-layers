/*! canvas-layers - v2.0.1 */
class Canvas{constructor(e,t={}){this.canvas=e,this.width=e.width,this.height=e.height,this.ctx=e.getContext("2d"),this.layers=[],this.layer_state_pos=-1,this.layer_states=[],this.drawPromises=[],this.activeLayer=null,this.shiftKeyDown=!1,this.draggingActiveLayer=!1,this.resizingActiveLayer=!1,this.rotatingActiveLayer=!1,this.lastMouseDownOffset={x:0,y:0},this.activeLayerMouseOffset={x:0,y:0},this.activeLayerOriginalDimensions={width:0,height:0},this.activeLayerRotateStartPos={x:0,y:0},this.displayGrid=!1,this.snapToGrid=!1,this.gridDistancePixels=10,e.addEventListener("mousemove",this.onmousemove.bind(this)),e.addEventListener("mousedown",this.onmousedown.bind(this)),e.addEventListener("mouseout",this.onmousereset.bind(this)),e.addEventListener("mouseup",this.onmousereset.bind(this)),e.addEventListener("click",this.onclick.bind(this)),e.addEventListener("dblclick",this.ondblclick.bind(this)),document.addEventListener("keydown",this.onkeyevent.bind(this)),document.addEventListener("keyup",this.onkeyevent.bind(this)),this.anchorRadius=t.anchorRadius||Canvas.anchorRadius,this.strokeStyle=t.strokeStyle||Canvas.strokeStyle,this.fillStyle=t.fillStyle||Canvas.fillStyle,this.lineWidth=t.lineWidth||Canvas.lineWidth,this.cursors=t.cursors||{},this.cursors.default=this.cursors.default||Canvas.cursors.default,this.cursors.grab=this.cursors.grab||Canvas.cursors.grab,this.cursors.grabbing=this.cursors.grabbing||Canvas.cursors.grabbing,this.cursors.move=this.cursors.move||Canvas.cursors.move,this.cursors.rotate=this.cursors.rotate||Canvas.cursors.rotate,this.cursors.rotating=this.cursors.rotating||Canvas.cursors.rotating,this.last_clicked_layer=null,this.pending_layers=0,this.ready=!0,this.muteStateChanges=!1,this.isCtrlPressed=!1,this.ctrlGroupLayer=new CanvasLayerGroup("ctrl-grp")}isLayerInGroup(e){return!!~this.ctrlGroupLayer.layers.indexOf(e)}isGroupOnCanvas(){return!!~this.layers.indexOf(this.ctrlGroupLayer)}async destroyCtrlGroup(){this.muteStateChanges=!0;var e=this.ctrlGroupLayer.layers.map(e=>new Promise(t=>{this.addLayer(e),e.onload(()=>t())}));await Promise.all(e),this.ctrlGroupLayer.layers=[],this.ctrlGroupLayer.rotation=0,this.isGroupOnCanvas()&&this.removeLayer(this.ctrlGroupLayer),this.muteStateChanges=!1}loadState(e){this.layers=e.map(e=>CanvasLayer.deobjectify(e)),this.draggingActiveLayer=!1,this.resizingActiveLayer=!1,this.rotatingActiveLayer=!1,this.lastMouseDownOffset={x:0,y:0},this.activeLayerMouseOffset={x:0,y:0},this.activeLayerOriginalDimensions={width:0,height:0},this.activeLayerRotateStartPos={x:0,y:0},this.draw()}saveState(){if(this.muteStateChanges)return;var e=[];const t=a=>{a.forEach(a=>{a instanceof CanvasLayerGroup?t(a.layers):e.push(a.objectify())})};t(this.layers),this.layer_states.length=this.layer_state_pos+1,this.layer_states.push(e),this.layer_state_pos=this.layer_states.length-1}undo(){this.layer_state_pos>0&&(this.layer_state_pos--,this.loadState(this.layer_states[this.layer_state_pos]))}redo(){this.layer_state_pos+1<this.layer_states.length&&(this.layer_state_pos++,this.loadState(this.layer_states[this.layer_state_pos]))}snapOn(e=10){this.snapToGrid=!0,e=+e<3?3:+e,this.gridDistancePixels=e}snapOff(){this.snapToGrid=!1,this.draw()}showGrid(e=10){this.displayGrid=!0,e=+e<3?3:+e,this.gridDistancePixels=e,this.draw()}hideGrid(){this.displayGrid=!1,this.draw()}getLayerByName(e){for(var t=this.layers.length;t--;)if(this.layers[t].name===e)return this.layers[t];return null}addLayer(e,t={}){if(this.ready=!1,e instanceof CanvasLayer)var a=e;else{const i=t.name||`Layer ${this.layers.length}`,s=parseFloat(t.x||this.width/2),r=parseFloat(t.y||this.height/2),h=parseFloat(t.rotation||0),n=void 0===t.draggable||t.draggable,o=void 0===!!t.rotateable||t.rotateable,l=void 0===!!t.resizable||t.resizable,c=void 0===!!t.selectable||t.selectable,y=t.width||null,d=t.height||null,u=t.forceBoundary||!1,v=!t.hasOwnProperty("allowOverlap")||!!t.allowOverlap;a=new CanvasLayer(e,i,s,r,y,d,h,n,o,l,c,u,v)}return this.layers.unshift(a),this.pending_layers++,a.onload(()=>{this.pending_layers--,0===this.pending_layers&&(this.ready=!0,this.draw(),this.saveState(),a instanceof CanvasLayerGroup||this.fireEvent("layer-added"))}),a}cropToLayer(e,t=!0){return this.extractPortion(e.x,e.y,e.width,e.height,e.rotation,t)}async extractPortion(e,t,a,i,s=0,r=!0){var h=s*Math.PI/180,{x:n,y:o}=Canvas.absolutePoint(-a/2,-i/2,e,t,s),l=this.getRotatedRectBB(n,o,a,i,h),c=document.createElement("canvas"),y=c.getContext("2d"),d=document.createElement("canvas"),u=d.getContext("2d"),v=document.createElement("canvas"),g=v.getContext("2d");d.width=v.width=l.width,d.height=v.height=l.height,c.width=this.width,c.height=this.height,await this.loadAll();for(let e=this.layers.length;e--;){let t=this.layers[e];h=t.rotation*(Math.PI/180);y.translate(t.x,t.y),y.rotate(h),y.drawImage(t.image,-t.width/2,-t.height/2,t.width,t.height),y.rotate(-h),y.translate(-t.x,-t.y)}if(u.drawImage(c,l.cx-l.width/2,l.cy-l.height/2,l.width,l.height,0,0,l.width,l.height),!r)return d.toDataURL();g.translate(d.width/2,d.height/2),g.rotate(-h),g.drawImage(d,-d.width/2,-d.height/2);var p=(v.width-a)/2,L=(v.height-i)/2;return u.clearRect(0,0,d.width,d.height),d.width=a,d.height=i,u.drawImage(v,-p,-L),d.toDataURL()}draw(){return new Promise(e=>{if(this.drawPromises.push(e),this.ready){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(let e=this.layers.length;e--;){let a=this.layers[e];var t=a.rotation*(Math.PI/180);this.ctx.translate(a.x,a.y),this.ctx.rotate(t),this.ctx.drawImage(a.image,-a.width/2,-a.height/2,a.width,a.height),a===this.activeLayer&&(this.ctx.strokeStyle=this.strokeStyle,this.ctx.fillStyle=this.fillStyle,this.ctx.lineWidth=this.getScale()*this.lineWidth,this.ctx.strokeRect(-a.width/2,-a.height/2,a.width,a.height),a.resizable&&a.getCorners().forEach(e=>{this.drawCircle(e.x,e.y,this.getScale()*this.anchorRadius)}),a.rotateable&&(this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.lineTo(a.width/2+25,0),this.ctx.stroke(),this.drawCircle(a.width/2+25,0,this.getScale()*this.anchorRadius))),this.ctx.rotate(-t),this.ctx.translate(-a.x,-a.y)}if(this.displayGrid){this.ctx.strokeStyle="rgba(0,0,0,0.2)",this.ctx.lineWidth=2*this.getScale();var{xs:a,ys:i}=this.getGridLines(!1);a.forEach(e=>{this.ctx.beginPath(),this.ctx.moveTo(e,0),this.ctx.lineTo(e,this.canvas.height),this.ctx.stroke()}),i.forEach(e=>{this.ctx.beginPath(),this.ctx.moveTo(0,e),this.ctx.lineTo(this.canvas.width,e),this.ctx.stroke()})}for(;this.drawPromises.length;)this.drawPromises.shift()()}})}removeAllLayers(){this.deSelectLayer(),this.layers=[],this.draw()}removeLayer(e){e===this.activeLayer&&this.deSelectLayer(),this.layers.splice(this.layers.indexOf(e),1),this.saveState(),this.draw()}selectLayer(e){this.layers.unshift(this.layers.splice(this.layers.indexOf(e),1)[0]),this.activeLayer=e,this.draw(),this.fireEvent("layer-selected")}deSelectLayer(){this.activeLayer=null,this.draggingActiveLayer=!1,this.draw(),this.fireEvent("layer-deselected")}canvasMousePos(e){var t=this.canvas.getBoundingClientRect(),a=e.clientX-t.left,i=e.clientY-t.top,s=this.canvas.width/t.width,r=this.canvas.height/t.height;return{x:a*=s,y:i*=r}}getLayerAt(e,t){for(let a=0;a<this.layers.length;a++){let i=this.layers[a];if(Canvas.isOverLayer(e,t,i))return i}return null}isOverSelectableLayer(e,t){for(let a=this.layers.length;a--;)if(Canvas.isOverLayer(e,t,this.layers[a])&&this.layers[a].selectable&&this.activeLayer!==this.layers[a])return!0;return!1}getOverlappingLayers(e){for(var t=[],a=0;a<this.layers.length;a++)this.layers[a]!==e&&this.doLayersOverlap(e,this.layers[a])&&t.push(this.layers[a]);return t}getGridLines(e=!0){var t=[],a=[],i=0;i=e?this.gridDistancePixels:2*this.gridDistancePixels;for(var s=0;s<this.canvas.width;s+=this.getScale()*i)t.push(s);for(var r=0;r<this.canvas.height;r+=this.getScale()*i)a.push(r);for(let i=this.layers.length;i--;)e&&this.layers[i]===this.activeLayer||(t.push(this.layers[i].x),a.push(this.layers[i].y));return[...new Set(t)].sort(),[...new Set(a)].sort(),{xs:t,ys:a}}loadAll(){var e=this.layers.map(e=>e.load());return Promise.all(e)}getRotatedRectBB(e,t,a,i,s){var r=Math.abs(Math.cos(s)),h=Math.abs(Math.sin(s));return{cx:e+a/2*Math.cos(s)-i/2*Math.sin(s),cy:t+a/2*Math.sin(s)+i/2*Math.cos(s),width:a*r+i*h,height:a*h+i*r}}drawCircle(e,t,a){this.ctx.beginPath(),this.ctx.arc(e,t,a,0,2*Math.PI,!0),this.ctx.closePath(),this.ctx.fill()}onkeyevent(e){"Shift"===e.key&&("keydown"===e.type?this.shiftKeyDown=!0:this.shiftKeyDown=!1),"Control"===e.key&&("keydown"===e.type?this.isCtrlPressed=!0:this.isCtrlPressed=!1),!this.isCtrlPressed&&this.isGroupOnCanvas()&&this.destroyCtrlGroup()}doLayersOverlap(e,t){const a=e=>e.getCorners().map(t=>Canvas.absolutePoint(t.x,t.y,e.x,e.y,e.rotation)),i=e=>[[{x:e[0].x,y:e[0].y},{x:e[1].x,y:e[1].y}],[{x:e[1].x,y:e[1].y},{x:e[2].x,y:e[2].y}],[{x:e[2].x,y:e[2].y},{x:e[3].x,y:e[3].y}],[{x:e[3].x,y:e[3].y},{x:e[0].x,y:e[0].y}]];var s=i(a(e)),r=i(a(t));for(let e=0;e<s.length;e++)for(let t=0;t<r.length;t++){let a=s[e][0].x,i=s[e][0].y,h=s[e][1].x,n=s[e][1].y,o=r[t][0].x,l=r[t][0].y,c=r[t][1].x,y=r[t][1].y;if(Canvas.doLinesIntersect(a,i,h,n,o,l,c,y))return!0}var h=e.getCorners()[0];if(h=Canvas.absolutePoint(h.x,h.y,e.x,e.y,e.rotation),Canvas.isOverLayer(h.x,h.y,t))return!0;var n=t.getCorners()[0];return n=Canvas.absolutePoint(n.x,n.y,t.x,t.y,t.rotation),!!Canvas.isOverLayer(n.x,n.y,e)}canMoveActiveLayer(e,t){const a=this.isNewPosInBounds(this.activeLayer,e,t,this.activeLayer.width,this.activeLayer.height);if(this.activeLayer.forceBoundary&&!a)return!1;var i=this.activeLayer.x,s=this.activeLayer.y;this.activeLayer.x=e,this.activeLayer.y=t;for(var r=!0,h=0;h<this.layers.length;h++)if(this.layers[h]!==this.activeLayer&&(!this.activeLayer.allowOverlap||!this.layers[h].allowOverlap)&&this.doLayersOverlap(this.activeLayer,this.layers[h])){r=!1;break}return this.activeLayer.x=i,this.activeLayer.y=s,r}canResizeActiveLayer(e,t){const a=this.isNewPosInBounds(this.activeLayer,this.activeLayer.x,this.activeLayer.y,e,t);if(this.activeLayer.forceBoundary&&!a)return!1;var i=this.activeLayer.width,s=this.activeLayer.height;this.activeLayer.width=i,this.activeLayer.height=s;for(var r=!0,h=0;h<this.layers.length;h++)if(this.layers[h]!==this.activeLayer&&(!this.activeLayer.allowOverlap||!this.layers[h].allowOverlap)&&this.doLayersOverlap(this.activeLayer,this.layers[h])){r=!1;break}return this.activeLayer.width=i,this.activeLayer.height=s,r}canRotateActiveLayer(e){var t=this.activeLayer.rotation;this.activeLayer.rotation=e;const a=this.isNewPosInBounds(this.activeLayer,this.activeLayer.x,this.activeLayer.y,this.activeLayer.width,this.activeLayer.height);if(this.activeLayer.forceBoundary&&!a)return!1;for(var i=!0,s=0;s<this.layers.length;s++)if(this.layers[s]!==this.activeLayer&&(!this.activeLayer.allowOverlap||!this.layers[s].allowOverlap)&&this.doLayersOverlap(this.activeLayer,this.layers[s])){i=!1;break}return this.activeLayer.rotation=t,i}onmousemove(e){var{x:t,y:a}=this.canvasMousePos(e);if(this.setCursor(t,a),null!==this.activeLayer)if(this.rotatingActiveLayer){var i=t-this.activeLayer.x,s=a-this.activeLayer.y,r=180*Math.atan2(s,i)/Math.PI;if(!this.canRotateActiveLayer(r))return this.rotatingActiveLayer=!1,void this.draw();this.fireEvent("layer-rotate")&&(this.activeLayer.rotation=r,this.activeLayer instanceof CanvasLayerGroup&&this.activeLayer.updateLayers(),this.draw())}else if(this.draggingActiveLayer){const e=this.activeLayerMouseOffset.x+t,i=this.activeLayerMouseOffset.y+a;if(!this.canMoveActiveLayer(e,i))return this.draggingActiveLayer=!1,void this.draw();if(this.fireEvent("layer-drag")){var h=e-this.activeLayer.x,n=i-this.activeLayer.y;this.activeLayer.x+=h,this.activeLayer.y+=n,this.activeLayer instanceof CanvasLayerGroup&&this.activeLayer.updateLayers(),this.draw()}}else if(this.resizingActiveLayer){const{width:e,height:i}=this.calculateLayerResize(t,a);if(!this.canResizeActiveLayer(e,i))return this.draggingActiveLayer=!1,void this.draw();this.fireEvent("layer-resize")&&(this.activeLayer.width=e,this.activeLayer.height=i,this.activeLayer instanceof CanvasLayerGroup&&this.activeLayer.updateLayers(),this.draw())}}setCursor(e,t){this.rotatingActiveLayer?document.body.style.cursor=this.cursors.rotating:this.draggingActiveLayer?document.body.style.cursor=this.cursors.grabbing:this.resizingActiveLayer?document.body.style.cursor=this.cursors.move:this.isNearActiveCorner(e,t)?document.body.style.cursor=this.cursors.move:this.isNearActiveRotatePoint(e,t)?document.body.style.cursor=this.cursors.rotate:this.isOverSelectableLayer(e,t)?document.body.style.cursor=this.cursors.grab:document.body.style.cursor=this.cursors.default}calculateLayerResize(e,t){var a=this.activeLayer.width,i=this.activeLayer.height,s=this.lastMouseDownOffset,r=Canvas.layerRelativePoint(e,t,this.activeLayer);if(a=s.x>0?Math.abs(this.activeLayerOriginalDimensions.width-2*(s.x-r.x)):Math.abs(this.activeLayerOriginalDimensions.width-2*(r.x-s.x)),i=s.y>0?Math.abs(this.activeLayerOriginalDimensions.height-2*(s.y-r.y)):Math.abs(this.activeLayerOriginalDimensions.height-2*(r.y-s.y)),this.shiftKeyDown){var h=Math.min(a/this.activeLayerOriginalDimensions.width,i/this.activeLayerOriginalDimensions.height);a=this.activeLayerOriginalDimensions.width*h,i=this.activeLayerOriginalDimensions.height*h}return{width:a,height:i}}fireEvent(e){var t=new CustomEvent(e,{detail:this,cancelable:!0,bubbles:!0});return this.canvas.dispatchEvent(t)}onclick(e){var{x:t,y:a}=this.canvasMousePos(e),i=this.getLayerAt(t,a);i&&(this.last_clicked_layer=i,this.fireEvent("layer-click"))}ondblclick(e){var{x:t,y:a}=this.canvasMousePos(e),i=this.getLayerAt(t,a);i&&(this.last_clicked_layer=i,this.fireEvent("layer-dblclick"))}async onmousedown(e){var{x:t,y:a}=this.canvasMousePos(e);if(this.setCursor(t,a),this.isNearActiveRotatePoint(t,a))this.fireEvent("layer-rotate-start")&&(this.activeLayerRotateStartPos={x:t,y:a},this.rotatingActiveLayer=!0);else if(this.isNearActiveCorner(t,a))this.fireEvent("layer-resize-start")&&(this.resizingActiveLayer=!0);else{var i,s=!1;null!==(i=this.getLayerAt(t,a))&&!1===i.selectable&&(i=null),null!==i&&null!==this.activeLayer&&i!==this.activeLayer&&((s=!this.fireEvent("layer-deselect"))||this.deSelectLayer()),!s&&null!==i&&this.fireEvent("layer-drag-start")&&(this.activeLayerMouseOffset.x=i.x-t,this.activeLayerMouseOffset.y=i.y-a,i.draggable&&(this.draggingActiveLayer=!0),i!==this.activeLayer&&this.fireEvent("layer-select")&&this.selectLayer(i))}this.activeLayer&&(this.activeLayerOriginalDimensions={width:this.activeLayer.width,height:this.activeLayer.height},this.lastMouseDownOffset=Canvas.layerRelativePoint(t,a,this.activeLayer)),(i=this.getLayerAt(t,a))&&i!==this.ctrlGroupLayer&&i.selectable&&(this.isCtrlPressed||this.destroyCtrlGroup(),this.isLayerInGroup(i)||(this.muteStateChanges=!0,await this.ctrlGroupLayer.addLayer(i),1===this.ctrlGroupLayer.layers.length&&this.selectLayer(i),i.onload(()=>{this.muteStateChanges=!1})),!this.isGroupOnCanvas()&&this.ctrlGroupLayer.layers.length>1&&(this.muteStateChanges=!0,this.ctrlGroupLayer.layers.forEach(e=>{this.removeLayer(e)}),this.addLayer(this.ctrlGroupLayer),this.ctrlGroupLayer.onload(()=>{this.muteStateChanges=!1})),this.isGroupOnCanvas()&&this.selectLayer(this.ctrlGroupLayer))}isNearActiveRotatePoint(e,t){if(!this.activeLayer||!this.activeLayer.rotateable)return!1;var{x:e,y:t}=Canvas.layerRelativePoint(e,t,this.activeLayer),a=this.activeLayer.width/2+25;return Math.hypot(a-e,0-t)<=this.getScale()*this.anchorRadius}isNearActiveCorner(e,t){if(!this.activeLayer||!this.activeLayer.resizable)return!1;var{x:e,y:t}=Canvas.layerRelativePoint(e,t,this.activeLayer),a=!1;return this.activeLayer.getCorners().forEach(i=>{Math.hypot(i.x-e,i.y-t)<=this.getScale()*this.anchorRadius&&(a=!0)}),a}isNewPosInBounds(e,t,a,i,s){var r=e.x,h=e.y,n=e.width,o=e.height;e.x=t,e.y=a,e.width=i,e.height=s;var l=!0;return e.getCorners().forEach(t=>{var a=Canvas.absolutePoint(t.x,t.y,e.x,e.y,e.rotation);(a.x<0||a.x>this.width||a.y<0||a.y>this.width)&&(l=!1)}),e.x=r,e.y=h,e.width=n,e.height=o,l}getNearestGridline(e,t){return Object.values(t.reduce((t,a)=>(a>e?null===t.high?t.high=a:t.high=Math.min(t.high,a):null===t.low?t.low=a:t.low=Math.max(t.low,a),t),{low:null,high:null})).reduce((t,a)=>{var i=Math.abs(a-e),s=null===t?null:Math.abs(t-e);return(null===t||i<s)&&(t=a),t},null)}onmousereset(e){if(this.draggingActiveLayer&&this.fireEvent("layer-drag-end"),this.resizingActiveLayer&&this.fireEvent("layer-resize-end"),this.rotatingActiveLayer&&this.fireEvent("layer-rotate-end"),this.draggingActiveLayer&&this.snapToGrid&&this.activeLayer){var{xs:t,ys:a}=this.getGridLines(),i=this.getNearestGridline(this.activeLayer.x,t),s=this.getNearestGridline(this.activeLayer.y,a),r=!1,h=Math.abs(i-this.activeLayer.x);h<=this.gridDistancePixels&&0!==h&&(this.activeLayer.x=i,r=!0),(h=Math.abs(s-this.activeLayer.y))<=this.gridDistancePixels&&0!==h&&(this.activeLayer.y=s,r=!0),r&&this.draw()}(this.draggingActiveLayer||this.resizingActiveLayer||this.rotatingActiveLayer)&&this.saveState();var{x:n,y:o}=this.canvasMousePos(e);this.draggingActiveLayer=!1,this.resizingActiveLayer=!1,this.rotatingActiveLayer=!1,this.lastMouseDownOffset={x:0,y:0},this.activeLayerMouseOffset={x:0,y:0},this.activeLayerOriginalDimensions={width:0,height:0},this.activeLayerRotateStartPos={x:0,y:0},this.setCursor(n,o)}getScale(){var e=this.canvas.getBoundingClientRect();return this.canvas.width/e.width}}Canvas.version="2.0.1",Canvas.anchorRadius=8,Canvas.strokeStyle="#ba0000",Canvas.fillStyle="black",Canvas.lineWidth=5,Canvas.cursors={default:null,grab:"grab",grabbing:"grabbing",move:"crosshair",rotate:"grab",rotating:"grabbing"},Canvas.absolutePoint=((e,t,a,i,s)=>{var r=s*(Math.PI/180),h=Math.cos(r),n=Math.sin(r);return{x:a+e*h-t*n,y:i+e*n+t*h}}),Canvas.relativePoint=((e,t,a,i,s)=>{e-=a,t-=i;var r=s*(Math.PI/180),h=Math.cos(r),n=Math.sin(r),o=e*h+t*n,l=-e*n+t*h;return{x:o=Math.floor(100*o)/100,y:l=Math.floor(100*l)/100}}),Canvas.layerRelativePoint=((e,t,a)=>Canvas.relativePoint(e,t,a.x,a.y,a.rotation)),Canvas.isOverLayer=((e,t,a)=>{let i=Canvas.layerRelativePoint(e,t,a);return!(i.x>a.width/2)&&(!(i.x<-a.width/2)&&(!(i.y>a.height/2)&&!(i.y<-a.height/2)))}),Canvas.doLinesIntersect=((e,t,a,i,s,r,h,n)=>{var o,l,c;return 0!==(o=(a-e)*(n-r)-(h-s)*(i-t))&&(l=((t-i)*(h-e)+(a-e)*(n-t))/o,0<(c=((n-r)*(h-e)+(s-h)*(n-t))/o)&&c<1&&0<l&&l<1)});class CanvasLayer{constructor(e,t,a,i,s=null,r=null,h=0,n=!0,o=!0,l=!0,c=!0,y=!1,d=!0){this.name=t,this.url=e,this.ready=!1,this.image=null,this.x=a,this.y=i,this.width=s,this.height=r,this.rotation=h,this.draggable=n,this.rotateable=o,this.resizable=l,this.selectable=c,this.forceBoundary=y,this.allowOverlap=d,this.load_cb_stack=[],this.xoffset=0,this.yoffset=0,this.roffset=0,this.owidth=0,this.oheight=0,this.load()}objectify(){return{layer:this,state:{name:this.name,url:this.url,x:this.x,y:this.y,width:this.width,height:this.height,rotation:this.rotation,draggable:this.draggable,rotatable:this.rotateable,resizable:this.resizable,selectable:this.selectable,forceBoundary:this.forceBoundary}}}onload(e){this.ready?e():this.load_cb_stack.push(e)}load(){return new Promise(e=>{if(this.ready)e();else{const t=new Image;t.onload=(()=>{this.image=t,null===this.width&&(this.width=t.width),null===this.height&&(this.height=t.height),this.ready=!0,this.load_cb_stack.forEach(e=>e()),this.load_cb_stack=[],e()}),t.src=this.url}})}getCorners(){return[{x:-this.width/2,y:-this.height/2},{x:-this.width/2+this.width,y:-this.height/2},{x:-this.width/2+this.width,y:-this.height/2+this.height},{x:-this.width/2,y:-this.height/2+this.height}]}}CanvasLayer.deobjectify=function(e){var t=e.layer;return Object.keys(e.state).forEach(a=>{t[a]=e.state[a]}),t};class CanvasLayerGroup extends CanvasLayer{constructor(e,t=!0,a=!0,i=!0,s=!0,r=!1){super("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/1+yHgAHtAKYD9BncgAAAABJRU5ErkJggg==",e,0,0,1,1,0,t,a,i,s,r),this.layers=[]}getLayerOrSubLayerAt(e,t,a){for(let i=0;i<e.layers.length;i++){let s=e.layers[i];if(s===this)for(let e=this.layers.length;e--;){let i=this.layers[e];if(Canvas.isOverLayer(t,a,i))return i}if(Canvas.isOverLayer(t,a,s))return s}return null}async removeLayer(e){return delete e.xoffset,delete e.yoffset,this.layers.splice(this.layers.indexOf(e),1),await this.regenerate()}async addLayer(e){if(e!==this)return e instanceof CanvasLayerGroup?this.layers.push(...e.layers):this.layers.push(e),await this.regenerate()}async regenerate(){var e=await this.getParams();return this.width=this.owidth=e.width,this.height=this.oheight=e.height,this.x=e.x,this.y=e.y,this.rotation=0,this.forceBoundary=e.forceBoundary,this.draggable=e.draggable,this.rotateable=e.rotateable,this.resizable=e.resizable,this.selectable=e.selectable,this.url=e.uri,this.ready=!1,await this.load()}updateLayers(){var e=this.width/this.owidth,t=this.height/this.oheight;this.layers.forEach(a=>{a.width=a.owidth*e,a.height=a.oheight*t,a.rotation=a.roffset+this.rotation;var i=Canvas.absolutePoint(a.xoffset*e,a.yoffset*t,this.x,this.y,this.rotation);a.x=i.x,a.y=i.y})}async getParams(){const e=[];this.layers.map(e=>e.getCorners().map(t=>Canvas.absolutePoint(t.x,t.y,e.x,e.y,e.rotation))).forEach(t=>{e.push(...t)});var t={left:e.reduce((e,t)=>Math.min(e,t.x),1/0),top:e.reduce((e,t)=>Math.min(e,t.y),1/0),right:e.reduce((e,t)=>Math.max(e,t.x),0),bottom:e.reduce((e,t)=>Math.max(e,t.y),0)};t.width=t.right-t.left,t.height=t.bottom-t.top,t.x=t.left+t.width/2,t.y=t.top+t.height/2;var a=document.createElement("canvas");a.width=t.right+2,a.height=t.bottom+2;var i=new Canvas(a);return this.layers.forEach(e=>i.addLayer(e)),t.uri=await i.extractPortion(t.x,t.y,t.width,t.height,0,!1),t.forceBoundary=this.layers.reduce((e,t)=>t.forceBoundary||e,!1),t.draggable=this.layers.reduce((e,t)=>!1!==e&&t.draggable,!0),t.rotateable=this.layers.reduce((e,t)=>!1!==e&&t.draggable,!0),t.resizable=this.layers.reduce((e,t)=>!1!==e&&t.draggable,!0),t.selectable=this.layers.reduce((e,t)=>!1!==e&&t.draggable,!0),this.layers.forEach(e=>{e.xoffset=e.x-t.x,e.yoffset=e.y-t.y,e.roffset=e.rotation,e.owidth=e.width,e.oheight=e.height}),t}}class DrawingCanvas extends Canvas{constructor(e,t={}){super(e,t),this.drawing_mode=null,this.line_color="#000000",this.fill_color="#0000FF",this.shape_start_pos=null,this.is_mouse_down=!1,this.freehand_coords=[],this.rcanvas=document.createElement("canvas"),this.rcanvas.height=this.height,this.rcanvas.width=this.width,this.rctx=this.rcanvas.getContext("2d"),this.ccanvas=document.createElement("canvas"),this.cctx=this.ccanvas.getContext("2d"),this.drawing_layer=null,this.layer_dimensions=null}setLineWidth(e){this.rctx.lineWidth=+e}setStrokeStyle(e){this.rctx.strokeStyle=e}setFillStyle(e){this.rctx.fillStyle=e}drawEllipse(e,t,a,i,s){var r=i/2*.5522848,h=s/2*.5522848,n=t+i,o=a+s,l=t+i/2,c=a+s/2;e.save(),e.beginPath(),e.moveTo(t,c),e.bezierCurveTo(t,c-h,l-r,a,l,a),e.bezierCurveTo(l+r,a,n,c-h,n,c),e.bezierCurveTo(n,c+h,l+r,o,l,o),e.bezierCurveTo(l-r,o,t,c+h,t,c),e.fill(),e.stroke(),e.restore()}renderLayer(){const{x:e,y:t,width:a,height:i}=this.layer_dimensions;this.ccanvas.width=a,this.ccanvas.height=i,this.cctx.clearRect(0,0,a,i),this.cctx.drawImage(this.rcanvas,e,t,a,i,0,0,a,i);var s=this.ccanvas.toDataURL();const r=e+a/2,h=t+i/2;this.drawing_layer?(this.drawing_layer.x=r,this.drawing_layer.y=h,this.drawing_layer.width=a,this.drawing_layer.height=i,this.drawing_layer.url=s,this.drawing_layer.ready=!1,this.drawing_layer.image=null,this.drawing_layer.load().then(()=>this.draw())):this.drawing_layer=this.addLayer(s,{xpos:r,ypos:h})}recalculateLayerDimensions(e){var t,a,i,s;if("freehand"===this.drawing_mode){this.freehand_coords.push(e);var r=this.freehand_coords.map(e=>e.x),h=this.freehand_coords.map(e=>e.y);t=Math.min(...r),a=Math.min(...h);var n=Math.max(...r),o=Math.max(...h);i=Math.max(.1,Math.abs(t-n)),s=Math.max(.1,Math.abs(a-o))}else t=Math.min(this.shape_start_pos.x,e.x),a=Math.min(this.shape_start_pos.y,e.y),i=Math.max(.1,Math.abs(this.shape_start_pos.x-e.x)),s=Math.max(.1,Math.abs(this.shape_start_pos.y-e.y));this.layer_dimensions={x:t,y:a,width:i,height:s}}onmousemove(e){if(!this.drawing_mode)return super.onmousemove(e);if(!this.is_mouse_down)return;this.rctx.clearRect(0,0,this.width,this.height);const t=this.canvasMousePos(e);switch(this.recalculateLayerDimensions(t),this.drawing_mode){case"rectangle":var{x:a,y:i,width:s,height:r}=this.layer_dimensions;this.rctx.beginPath(),this.rctx.rect(a,i,s,r),this.rctx.fill(),this.rctx.stroke(),this.renderLayer();break;case"ellipse":var{x:a,y:i,width:s,height:r}=this.layer_dimensions;this.drawEllipse(this.rctx,a,i,s,r),this.renderLayer();break;case"line":var h=this.shape_start_pos.x,n=this.shape_start_pos.y,o=t.x,l=t.y;this.rctx.beginPath(),this.rctx.moveTo(h,n),this.rctx.lineTo(o,l),this.rctx.fill(),this.rctx.stroke(),this.renderLayer();break;case"freehand":if(this.freehand_coords<2)break;for(var c=this.freehand_coords[0],y=1;y<this.freehand_coords.length;y++)this.rctx.beginPath(),this.rctx.moveTo(c.x,c.y),this.rctx.lineTo(this.freehand_coords[y].x,this.freehand_coords[y].y),this.rctx.fill(),this.rctx.stroke(),c=this.freehand_coords[y];this.renderLayer()}}onmousedown(e){if(!this.drawing_mode)return super.onmousedown(e);this.is_mouse_down=!0,this.shape_start_pos=this.canvasMousePos(e)}onmousereset(e){if(!this.drawing_mode)return super.onmousereset(e);this.is_mouse_down=!1,this.shape_start_pos=null,this.drawing_layer=null,this.layer_dimensions=null,this.freehand_coords=[]}}class CanvasFonts{}CanvasFonts.getNative=(async(e=!1)=>{if(CanvasFonts._native_available.length&&!e)return CanvasFonts._native_available;var t=[];return await document.fonts.ready,CanvasFonts._native_fontlist.forEach(e=>{document.fonts.check(`12px "${e}"`)&&t.push(e)}),CanvasFonts._native_available=[...new Set(t)].sort(),CanvasFonts._native_available}),CanvasFonts.getDownloaded=(async(e=!1)=>{if(CanvasFonts._downloaded_available.length&&!e)return CanvasFonts._downloaded_available;let{fonts:t}=document;const a=t.entries();let i=[],s=!1;for(;!s;){const e=a.next();if(e.done)s=e.done;else{var r;try{r=JSON.parse(e.value[0].family)}catch(t){r=e.value[0].family}i.push(r)}}return CanvasFonts._downloaded_available=[...new Set(i)].sort(),CanvasFonts._downloaded_available}),CanvasFonts.getAvailable=(async()=>{var e=await CanvasFonts.getNative(),t=await CanvasFonts.getDownloaded();return[...new Set([...e,...t])].sort()}),CanvasFonts._native_available=[],CanvasFonts._downloaded_available=[],CanvasFonts._native_fontlist=["Arial","Arial Unicode MS","Bitstream Cyberbit","BitstreamCyberCJK","Brampton","Cardo","Caslon Roman","Charis SIL","Chrysanthi Unicode","Chryſanþi Unicode","ClearlyU","Code2000","DejaVu Sans","Doulos SIL","Everson Mono","Gentium Regular","Gentium Plus","GNU FreeFont","Unifont","GNU Unifont","HAN NOM A","HAN NOM B","Horta","Junicode","Kelvinch","Linux Libertine","Lucida Grande","Lucida Sans Unicode","Microsoft JhengHei","Microsoft Sans Serif","New Gulim","Noto","PragmataPro","Quivira","Segoe UI Regular","Squarish Sans CT","STIX","Sun-ExtA","Sun-ExtB","Tahoma","Times New Roman","TITUS Cyberbit Basic","WenQuanYi Bitmap Song","WenQuanYi Micro Hei","WenQuanYi Zen Hei","Y.OzFontN","XITS","Aharoni","Aldhabi","Andalus","Angsana New","AngsanaUPC","Aparajita","Arabic Typesetting","Bahnschrift","Batang","BatangChe","BIZ UDGothic","BIZ UDPGothic","BIZ UDMincho","BIZ UDPMincho","Book Antiqua","Browallia New","BrowalliaUPC","Calibri","Calisto MT","Cambria","Cambria Math","Candara","Century Gothic","Comic Sans MS","Consolas","Constantia","Copperplate Gothic","Corbel","Cordia New","CordiaUPC","Courier New","DaunPenh","David","DengXian","DilleniaUPC","DFKai-SB","DokChampa","Dotum","DotumChe","Ebrima","Estrangelo Edessa","EucrosiaUPC","Euphemia","FangSong","Franklin Gothic","FrankRuehl","FreesiaUPC","Gabriola","Gadugi","Gautami","Georgia","Gisha","Gulim","GulimChe","Gungsuh","GungsuhChe","HoloLens MDL2 Assets","Impact","Ink Free","IrisUPC","Iskoola Pota","JasmineUPC","Javanese Text","SimKai","KaiTi","Kalinga","Kartika","Khmer UI","KodchiangUPC","Kokila","Lao UI","Latha","Leelawadee","Leelawadee UI","Levenim MT","LilyUPC","Lucida Console","Lucida Handwriting","Malgun Gothic","Mangal","Marlett","Meiryo","Meiryo UI","Microsoft Himalaya","Microsoft JhengHei UI","Microsoft New Tai Lue","Microsoft PhagsPa","Microsoft Tai Le","Microsoft Uighur","Microsoft YaHei","Microsoft YaHei UI","Microsoft Yi Baiti","MingLiU","PMingLiU","MingLiU-ExtB","PMingLiU-ExtB","MingLiU_HKSCS","MingLiU_HKSCS-ExtB","Miriam","Miriam Fixed","Mongolian Baiti","MoolBoran","MS Gothic","MS PGothic","MS Mincho","MS PMincho","MS UI Gothic","MV Boli","Myanmar Text","Narkisim","Nirmala UI","NSimSun","Nyala","Palatino Linotype","Plantagenet Cherokee","Raavi","Rod","Sakkal Majalla","Sanskrit Text","Segoe MDL2 Assets","Segoe Print","Segoe Script","Segoe SD","Segoe UI","Segoe UI Emoji","Segoe UI Historic","Segoe UI Symbol","Shonar Bangla","Shruti","SimHei","Simplified Arabic","SimSun","SimSun-ExtB","Sitka Banner","Sitka Display","Sitka Heading","Sitka Small","Sitka Subheading","Sitka Text","Sylfaen","Symbol","Traditional Arabic","Trebuchet MS","Tunga","UD Digi Kyokasho","Urdu Typesetting","Utsaah","Vani","Verdana","Vijaya","Vrinda","Webdings","Wingdings","Yu Gothic","Yu Gothic UI","Yu Mincho","Al Bayan","American Typewriter","Andalé Mono","Apple Casual","Apple Chancery","Apple Garamond","Apple Gothic","Apple LiGothic","Apple LiSung","Apple Myungjo","Apple Symbols",".AquaKana","Arial Hebrew","Ayuthaya","Baghdad","Baskerville","Beijing","BiauKai","Big Caslon","Brush Script","Chalkboard","Chalkduster","Charcoal","Charcoal CY","Chicago","Cochin","Comic Sans","Cooper","Copperplate","Corsiva Hebrew","Courier","DecoType Naskh","Devanagari","Didot","Euphemia UCAS","Futura","Gadget","Geeza Pro","Geezah","Geneva","Geneva CY","Gill Sans","Gujarati","Gung Seoche","Gurmukhi","Hangangche","HeadlineA","Hei","Helvetica","Helvetica CY","Helvetica Neue","Herculanum","Hiragino Kaku Gothic Pro","Hiragino Kaku Gothic ProN","Hiragino Kaku Gothic Std","Hiragino Kaku Gothic StdN","Hiragino Maru Gothic Pro","Hiragino Maru Gothic ProN","Hiragino Mincho Pro","Hiragino Mincho ProN","Hoefler Text","Inai Mathi","Jung Gothic","Kai","Keyboard","Krungthep","KufiStandard GK","Kuenstler Script","LastResort","LiHei Pro","LiSong Pro","Lucida Sans","Marker Felt","Menlo","Monaco","Monaco CY","Mshtakan","Nadeem","New Peninim","New York","NISC GB18030","Optima","Osaka","Palatino","Papyrus","PC Myungjo","Pilgiche","Raanana","Sand","Sathu","Seoul","Shin Myungjo Neue","Silom","Skia","Snell Roundhand","ST FangSong","ST FangSong 2","ST Heiti","ST Kaiti","ST Song","Tae Graphic","Taipei","Techno","Textile","Thonburi","Times","Times CY","Zapf Chancery","Zapf Dingbats","Zapfino"];class CanvasKeyLogger{constructor(e){this.element=e.element||document,this.input=[],this.cursor_pos=0,this.enabled=!1,this.event_type=e.event_type||"keydown",this._key_event_handler=this.key_event_handler.bind(this),this.on_input=(e.on_input||function(){}).bind(this),this.on_nav_key=(e.on_nav_key||function(){}).bind(this),e.hasOwnProperty("autostart")&&!1===e.autostart||this.enable()}key_event_handler(e){if(CanvasKeyLogger.NAMED_INPUT_KEYS[e.key])input.splice(this.cursor_pos,0,CanvasKeyLogger.NAMED_INPUT_KEYS[e.key]),this.cursor_pos++,this.on_input();else if(CanvasKeyLogger.CONTROL_KEYS.includes(e.key))switch(e.key){case"ArrowDown":this.on_nav_key();break;case"ArrowLeft":this.cursor_pos>0&&this.cursor_pos--,this.on_nav_key();break;case"ArrowRight":this.input.length>this.cursor_pos&&this.cursor_pos++,this.on_nav_key();break;case"ArrowUp":this.on_nav_key();break;case"End":this.cursor_pos=this.input.length-1,this.on_nav_key();break;case"Home":this.cursor_pos=0,this.on_nav_key();break;case"Backspace":this.cursor_pos>0&&(this.input.splice(this.cursor_pos-1,1),this.cursor_pos--,this.on_input());break;case"Delete":this.input.length>this.cursor_pos&&(this.input.splice(this.cursor_pos,1),this.on_input())}else CanvasKeyLogger.NON_INPUT_KEYS.includes(e.key)||(this.input.splice(this.cursor_pos,0,e.key),this.cursor_pos++,this.on_input())}val(e=!1,t="CURSOR"){if(e){var a,i=[];for(a=0;a<this.input.length;a++)a==this.cursor_pos&&i.push(t),i.push(this.input[a]);return a==this.cursor_pos&&i.push(t),i}return this.input.join("")}enable(){this.enabled=!0,this.element.addEventListener(this.event_type,this._key_event_handler)}disable(){this.enabled=!1,this.element.removeEventListener(this.event_type,this._key_event_handler)}}CanvasKeyLogger.NAMED_INPUT_KEYS={Enter:"\n",Tab:"\t"},CanvasKeyLogger.CONTROL_KEYS=["ArrowDown","ArrowLeft","ArrowRight","ArrowUp","End","Home","Backspace","Delete"],CanvasKeyLogger.NON_INPUT_KEYS=["Unidentified","Alt","AltGraph","CapsLock","Control","Fn","FnLock","Hyper","Meta","NumLock","ScrollLock","Shift","Super","Symbol","SymbolLock","PageDown","PageUp","Clear","Copy","CrSel","Cut","EraseEof","ExSel","Insert","Paste","Redo","Undo","Accept","Again","Attn","Cancel","ContextMenu","Escape","Execute","Find","Finish","Help","Pause","Play","Props","Select","ZoomIn","ZoomOut","BrightnessDown","BrightnessUp","Eject","LogOff","Power","PowerOff","PrintScreen","Hibernate","Standby","WakeUp","AllCandidates","Alphanumeric","CodeInput","Compose","Convert","Dead","FinalMode","GroupFirst","GroupLast","GroupNext","GroupPrevious","ModeChange","NextCandidate","NonConvert","PreviousCandidate","Process","SingleCandidate","HangulMode","HanjaMode","JunjaMode","Eisu","Hankaku","Hiragana","HiraganaKatakana","KanaMode","KanjiMode","Katakana","Romaji","Zenkaku","ZenkakuHanaku","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12","F13","F14","F15","F16","F17","F18","F19","F20","Soft1","Soft2","Soft3","Soft4","AppSwitch","Call","Camera","CameraFocus","EndCall","GoBack","GoHome","HeadsetHook","LastNumberRedial","Notification","MannerMode","VoiceDial","ChannelDown","ChannelUp","MediaFastForward","MediaPause","MediaPlay","MediaPlayPause","MediaRecord","MediaRewind","MediaStop","MediaTrackNext","MediaTrackPrevious","AudioBalanceLeft","AudioBalanceRight","AudioBassDown","AudioBassBoostDown","AudioBassBoostToggle","AudioBassBoostUp","AudioBassUp","AudioFaderFront","AudioFaderRear","AudioSurroundModeNext","AudioTrebleDown","AudioTrebleUp","AudioVolumeDown","AudioVolumeMute","AudioVolumeUp","MicrophoneToggle","MicrophoneVolumeDown","MicrophoneVolumeMute","MicrophoneVolumeUp","TV","TV3DMode","TVAntennaCable","TVAudioDescription","TVAudioDescriptionMixDown","TVAudioDescriptionMixUp","TVContentsMenu","TVDataService","TVInput","TVInputComponent1","TVInputComponent2","TVInputComposite1","TVInputComposite2","TVInputHDMI1","TVInputHDMI2","TVInputHDMI3","TVInputHDMI4","TVInputVGA1","TVMediaContext","TVNetwork","TVNumberEntry","TVPower","TVRadioService","TVSatellite","TVSatelliteBS","TVSatelliteCS","TVSatelliteToggle","TVTerrestrialAnalog","TVTerrestrialDigital","TVTimer","AVRInput","AVRPower","ColorF0Red","ColorF1Green","ColorF2Yellow","ColorF3Blue","ColorF4Grey","ColorF5Brown","ClosedCaptionToggle","Dimmer","DisplaySwap","DVR","Exit","FavoriteClear0","FavoriteClear1","FavoriteClear2","FavoriteClear3","FavoriteRecall0","FavoriteRecall1","FavoriteRecall2","FavoriteRecall3","FavoriteStore0","FavoriteStore1","FavoriteStore2","FavoriteStore3","Guide","GuideNextDay","GuidePreviousDay","Info","InstantReplay","Link","ListProgram","LiveContent","Lock","MediaApps","MediaAudioTrack","MediaLast","MediaSkipBackward","MediaSkipForward","MediaStepBackward","MediaStepForward","MediaTopMenu","NavigateIn","NavigateNext","NavigateOut","NavigatePrevious","NextFavoriteChannel","NextUserProfile","OnDemand","Pairing","PinPDown","PinPMove","PinPToggle","PinPUp","PlaySpeedDown","PlaySpeedReset","PlaySpeedUp","RandomToggle","RcLowBattery","RecordSpeedNext","RfBypass","ScanChannelsToggle","ScreenModeNext","Settings","SplitScreenToggle","STBInput","STBPower","Subtitle","Teletext","VideoModeNext","Wink","ZoomToggle","SpeechCorrectionList","SpeechInputToggle","Close","New","Open","Print","Save","SpellCheck","MailForward","MailReply","MailSend","LaunchCalculator","LaunchCalendar","LaunchContacts","LaunchMail","LaunchMediaPlayer","LaunchMusicPlayer","LaunchMyComputer","LaunchPhone","LaunchScreenSaver","LaunchSpreadsheet","LaunchWebBrowser","LaunchWebCam","LaunchWordProcessor","LaunchApplication1","LaunchApplication2","LaunchApplication3","LaunchApplication4","LaunchApplication5","LaunchApplication6","LaunchApplication7","LaunchApplication8","LaunchApplication9","LaunchApplication10","LaunchApplication11","LaunchApplication12","LaunchApplication13","LaunchApplication14","LaunchApplication15","LaunchApplication16","BrowserBack","BrowserFavorites","BrowserForward","BrowserHome","BrowserRefresh","BrowserSearch","BrowserStop","Decimal","Key11","Key12","Multiply","Add","Clear","Divide","Subtract","Separator"];class TypingCanvas extends DrawingCanvas{constructor(e,t){this.active=!1,this.text="",this.canvas=e,this.type_area={},this.type_area.width=t.type_area.width||e.width,this.type_area.height=t.type_area.height||e.height,this.type_area.x=t.type_area.x||0,this.type_area.y=t.type_area.y||0,this._render_canvas=document.createElement("canvas"),this._render_canvas.width=this.type_area.width,this._render_canvas.height=this.type_area.height,this.last_render_background=null,this._keydownHandler=this.keydownHandler.bind(this),this.attachEventHandlers()}setTypeArea(e,t,a,i){this.type_area.width=a,this.type_area.height=i,this.type_area.x=e,this.type_area.y=t}keydownHandler(){}attachEventHandlers(){this.canvas.addEventListener(this._keydownHandler)}removeEventHandlers(){this.canvas.removeEventListener(this._keydownHandler)}}