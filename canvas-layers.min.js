/*! canvas-layers - v1.1.20 */
class Canvas{constructor(t,i={}){this.canvas=t,this.width=t.width,this.height=t.height,this.ctx=t.getContext("2d"),this.layers=[],this.activeLayer=null,this.shiftKeyDown=!1,this.draggingActiveLayer=!1,this.resizingActiveLayer=!1,this.rotatingActiveLayer=!1,this.lastMouseDownOffset={x:0,y:0},this.activeLayerMouseOffset={x:0,y:0},this.activeLayerOriginalDimensions={width:0,height:0},this.activeLayerRotateStartPos={x:0,y:0},this.gridDistancePixels=null,this.snapToGrid=!1,t.addEventListener("mousemove",this.onmousemove.bind(this)),t.addEventListener("mousedown",this.onmousedown.bind(this)),t.addEventListener("mouseout",this.onmousereset.bind(this)),t.addEventListener("mouseup",this.onmousereset.bind(this)),t.addEventListener("click",this.onclick.bind(this)),t.addEventListener("dblclick",this.ondblclick.bind(this)),document.addEventListener("keydown",this.onkeyevent.bind(this)),document.addEventListener("keyup",this.onkeyevent.bind(this)),this.anchorRadius=i.anchorRadius||Canvas.anchorRadius,this.strokeStyle=i.strokeStyle||Canvas.strokeStyle,this.fillStyle=i.fillStyle||Canvas.fillStyle,this.lineWidth=i.lineWidth||Canvas.lineWidth,this.cursors=i.cursors||{},this.cursors.default=this.cursors.default||Canvas.cursors.default,this.cursors.grab=this.cursors.grab||Canvas.cursors.grab,this.cursors.grabbing=this.cursors.grabbing||Canvas.cursors.grabbing,this.cursors.move=this.cursors.move||Canvas.cursors.move,this.cursors.rotate=this.cursors.rotate||Canvas.cursors.rotate,this.cursors.rotating=this.cursors.rotating||Canvas.cursors.rotating,this.last_clicked_layer=null,this.pending_layers=0,this.ready=!0}snapOn(){this.snapToGrid=!0}snapOff(){this.snapToGrid=!1}showGrid(t=25){this.gridDistancePixels=t,this.draw()}hideGrid(){this.gridDistancePixels&&(this.gridDistancePixels=null,this.draw())}getLayerByName(t){for(var i=this.layers.length;i--;)if(this.layers[i].name===t)return this.layers[i];return null}addLayer(t,i={}){this.ready=!1;const e=i.name||`Layer ${this.layers.length}`,s=parseFloat(i.x||this.width/2),a=parseFloat(i.y||this.height/2),h=parseFloat(i.rotation||0),r=void 0===i.draggable||i.draggable,n=void 0===!!i.rotateable||i.rotateable,o=void 0===!!i.resizable||i.resizable,c=void 0===!!i.selectable||i.selectable,l=i.width||null,y=i.height||null,d=i.forceBoundary||!1;var v=new CanvasLayer(t,e,s,a,l,y,h,r,n,o,c,d);return this.layers.unshift(v),this.pending_layers++,v.onload(()=>{this.pending_layers--,0===this.pending_layers&&(this.ready=!0,this.draw())}),v}cropToLayer(t){return this.extractPortion(t.x,t.y,t.width,t.height,t.rotation)}extractPortion(t,i,e,s,a=0){var h=a*Math.PI/180,{x:r,y:n}=this.absolutePoint(-e/2,-s/2,t,i,a),o=this.getRotatedRectBB(r,n,e,s,h),c=document.createElement("canvas"),l=c.getContext("2d"),y=document.createElement("canvas"),d=y.getContext("2d"),v=document.createElement("canvas"),g=v.getContext("2d");return y.width=v.width=o.width,y.height=v.height=o.height,c.width=this.width,c.height=this.height,new Promise(t=>{this.loadAll().then(()=>{for(let t=this.layers.length;t--;){let e=this.layers[t];var i=e.rotation*(Math.PI/180);l.translate(e.x,e.y),l.rotate(i),l.drawImage(e.image,-e.width/2,-e.height/2,e.width,e.height),l.rotate(-i),l.translate(-e.x,-e.y)}d.drawImage(c,o.cx-o.width/2,o.cy-o.height/2,o.width,o.height,0,0,o.width,o.height),g.translate(y.width/2,y.height/2),g.rotate(-i),g.drawImage(y,-y.width/2,-y.height/2);var a=(v.width-e)/2,h=(v.height-s)/2;d.clearRect(0,0,y.width,y.height),y.width=e,y.height=s,d.drawImage(v,-a,-h),t(y.toDataURL())})})}draw(){if(this.ready){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(let i=this.layers.length;i--;){let e=this.layers[i];var t=e.rotation*(Math.PI/180);this.ctx.translate(e.x,e.y),this.ctx.rotate(t),this.ctx.drawImage(e.image,-e.width/2,-e.height/2,e.width,e.height),e===this.activeLayer&&(this.ctx.strokeStyle=this.strokeStyle,this.ctx.fillStyle=this.fillStyle,this.ctx.lineWidth=this.getScale()*this.lineWidth,this.ctx.strokeRect(-e.width/2,-e.height/2,e.width,e.height),e.resizable&&e.getCorners().forEach(t=>{this.drawCircle(t.x,t.y,this.getScale()*this.anchorRadius)}),e.rotateable&&(this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.lineTo(e.width/2+25,0),this.ctx.stroke(),this.drawCircle(e.width/2+25,0,this.getScale()*this.anchorRadius))),this.ctx.rotate(-t),this.ctx.translate(-e.x,-e.y)}if(this.gridDistancePixels){this.ctx.strokeStyle="rgba(0,0,0,0.2)",this.ctx.lineWidth=2*this.getScale();var{xs:i,ys:e}=this.getGridLines();i.forEach(t=>{this.ctx.beginPath(),this.ctx.moveTo(t,0),this.ctx.lineTo(t,this.canvas.height),this.ctx.stroke()}),e.forEach(t=>{this.ctx.beginPath(),this.ctx.moveTo(0,t),this.ctx.lineTo(this.canvas.width,t),this.ctx.stroke()})}}}removeAllLayers(){this.deSelectLayer(),this.layers=[],this.draw()}removeLayer(t){t===this.activeLayer&&this.deSelectLayer(),this.layers.splice(this.layers.indexOf(t),1),this.draw()}selectLayer(t){this.layers.unshift(this.layers.splice(this.layers.indexOf(t),1)[0]),this.activeLayer=t,this.draw()}deSelectLayer(){this.activeLayer=null,this.draggingActiveLayer=!1,this.draw()}canvasMousePos(t){var i=this.canvas.getBoundingClientRect(),e=t.clientX-i.left,s=t.clientY-i.top,a=this.canvas.width/i.width,h=this.canvas.height/i.height;return{x:e*=a,y:s*=h}}getLayerAt(t,i){for(let e=0;e<this.layers.length;e++){let s=this.layers[e];if(this.isOverLayer(t,i,s))return s}return null}isOverSelectableLayer(t,i){for(let e=this.layers.length;e--;)if(this.isOverLayer(t,i,this.layers[e])&&this.layers[e].selectable&&this.activeLayer!==this.layers[e])return!0;return!1}isOverLayer(t,i,e){let s=this.layerRelativePoint(t,i,e);return!(s.x>e.width/2)&&(!(s.x<-e.width/2)&&(!(s.y>e.height/2)&&!(s.y<-e.height/2)))}getGridLines(){for(var t=[],i=[],e=0;e<this.canvas.width;e+=this.getScale()*this.gridDistancePixels)t.push(e);for(var s=0;s<this.canvas.height;s+=this.getScale()*this.gridDistancePixels)i.push(s);for(let e=this.layers.length;e--;)t.push(this.layers[e].x),i.push(this.layers[e].y);return t.sort(),i.sort(),{xs:t,ys:i}}loadAll(){var t=this.layers.map(t=>new Promise(i=>t.onload(i)));return Promise.all(t)}getRotatedRectBB(t,i,e,s,a){var h=Math.abs(Math.cos(a)),r=Math.abs(Math.sin(a));return{cx:t+e/2*Math.cos(a)-s/2*Math.sin(a),cy:i+e/2*Math.sin(a)+s/2*Math.cos(a),width:e*h+s*r,height:e*r+s*h}}drawCircle(t,i,e){this.ctx.beginPath(),this.ctx.arc(t,i,e,0,2*Math.PI,!0),this.ctx.closePath(),this.ctx.fill()}onkeyevent(t){this.shiftKeyDown=t.shiftKey}onmousemove(t){var{x:i,y:e}=this.canvasMousePos(t);if(this.setCursor(i,e),null!==this.activeLayer)if(this.rotatingActiveLayer){if(this.fireEvent("layer-rotate")){var s=i-this.activeLayer.x,a=e-this.activeLayer.y,h=180*Math.atan2(a,s)/Math.PI;this.activeLayer.rotation=h,this.draw()}}else if(this.draggingActiveLayer){const t=this.activeLayerMouseOffset.x+i,s=this.activeLayerMouseOffset.y+e;if(this.activeLayer.forceBoundary&&!this.isNewPosInBounds(this.activeLayer,t,s,this.activeLayer.width,this.activeLayer.height))return this.draggingActiveLayer=!1,void this.draw();this.fireEvent("layer-drag")&&(this.activeLayer.x=t,this.activeLayer.y=s,this.draw())}else if(this.resizingActiveLayer){const{width:t,height:s}=this.calculateLayerResize(i,e);if(this.activeLayer.forceBoundary&&!this.isNewPosInBounds(this.activeLayer,this.activeLayer.x,this.activeLayer.y,t,s))return this.draggingActiveLayer=!1,void this.draw();this.fireEvent("layer-resize")&&(this.activeLayer.width=t,this.activeLayer.height=s,this.draw())}}setCursor(t,i){this.rotatingActiveLayer?document.body.style.cursor=this.cursors.rotating:this.draggingActiveLayer?document.body.style.cursor=this.cursors.grabbing:this.resizingActiveLayer?document.body.style.cursor=this.cursors.move:this.isNearActiveCorner(t,i)?document.body.style.cursor=this.cursors.move:this.isNearActiveRotatePoint(t,i)?document.body.style.cursor=this.cursors.rotate:this.isOverSelectableLayer(t,i)?document.body.style.cursor=this.cursors.grab:document.body.style.cursor=this.cursors.default}calculateLayerResize(t,i){var e=this.activeLayer.width,s=this.activeLayer.height,a=this.lastMouseDownOffset,h=this.layerRelativePoint(t,i,this.activeLayer);if(e=a.x>0?Math.abs(this.activeLayerOriginalDimensions.width-2*(a.x-h.x)):Math.abs(this.activeLayerOriginalDimensions.width-2*(h.x-a.x)),s=a.y>0?Math.abs(this.activeLayerOriginalDimensions.height-2*(a.y-h.y)):Math.abs(this.activeLayerOriginalDimensions.height-2*(h.y-a.y)),this.shiftKeyDown){var r=Math.min(e/this.activeLayerOriginalDimensions.width,s/this.activeLayerOriginalDimensions.height);e=this.activeLayerOriginalDimensions.width*r,s=this.activeLayerOriginalDimensions.height*r}return{width:e,height:s}}fireEvent(t){var i=new CustomEvent(t,{detail:this,cancelable:!0,bubbles:!0});return this.canvas.dispatchEvent(i)}onclick(t){var{x:i,y:e}=this.canvasMousePos(t),s=this.getLayerAt(i,e);s&&(this.last_clicked_layer=s,this.fireEvent("layer-click"))}ondblclick(t){var{x:i,y:e}=this.canvasMousePos(t),s=this.getLayerAt(i,e);s&&(this.last_clicked_layer=s,this.fireEvent("layer-dblclick"))}onmousedown(t){var{x:i,y:e}=this.canvasMousePos(t);if(this.setCursor(i,e),this.isNearActiveRotatePoint(i,e))this.activeLayerRotateStartPos={x:i,y:e},this.rotatingActiveLayer=!0;else if(this.isNearActiveCorner(i,e))this.resizingActiveLayer=!0;else{var s=!1,a=this.getLayerAt(i,e);null!==a&&!1===a.selectable&&(a=null),null!==a&&null!==this.activeLayer&&a!==this.activeLayer&&((s=!this.fireEvent("layer-deselect"))||this.deSelectLayer()),s||null===a||(this.activeLayerMouseOffset.x=a.x-i,this.activeLayerMouseOffset.y=a.y-e,a.draggable&&(this.draggingActiveLayer=!0),a!==this.activeLayer&&this.fireEvent("layer-select")&&this.selectLayer(a))}this.activeLayer&&(this.activeLayerOriginalDimensions={width:this.activeLayer.width,height:this.activeLayer.height},this.lastMouseDownOffset=this.layerRelativePoint(i,e,this.activeLayer))}isNearActiveRotatePoint(t,i){if(!this.activeLayer||!this.activeLayer.rotateable)return!1;var{x:t,y:i}=this.layerRelativePoint(t,i,this.activeLayer),e=this.activeLayer.width/2+25;return Math.hypot(e-t,0-i)<=this.getScale()*this.anchorRadius}isNearActiveCorner(t,i){if(!this.activeLayer||!this.activeLayer.resizable)return!1;var{x:t,y:i}=this.layerRelativePoint(t,i,this.activeLayer),e=!1;return this.activeLayer.getCorners().forEach(s=>{Math.hypot(s.x-t,s.y-i)<=this.getScale()*this.anchorRadius&&(e=!0)}),e}isNewPosInBounds(t,i,e,s,a){var h=t.x,r=t.y,n=t.width,o=t.height;t.x=i,t.y=e,t.width=s,t.height=a;var c=!0;return t.getCorners().forEach(i=>{var e=this.absolutePoint(i.x,i.y,t.x,t.y,t.rotation);(e.x<0||e.x>this.width||e.y<0||e.y>this.width)&&(c=!1)}),t.x=h,t.y=r,t.width=n,t.height=o,c}layerRelativePoint(t,i,e){return this.relativePoint(t,i,e.x,e.y,e.rotation)}relativePoint(t,i,e,s,a){t-=e,i-=s;var h=a*(Math.PI/180),r=Math.cos(h),n=Math.sin(h),o=t*r+i*n,c=-t*n+i*r;return{x:o=Math.floor(100*o)/100,y:c=Math.floor(100*c)/100}}absolutePoint(t,i,e,s,a){var h=a*(Math.PI/180),r=Math.cos(h),n=Math.sin(h);return{x:e+t*r-i*n,y:s+t*n+i*r}}onmousereset(t){if(this.draggingActiveLayer&&this.snapToGrid&&this.activeLayer){for(var{xs:i,ys:e}=this.getGridLines(),s=!1,a=0;a<i.length;a++)if(Math.abs(i[a]-this.activeLayer.x)<=5){this.activeLayer.x=i[a],s=!0;break}for(a=0;a<e.length;a++)if(Math.abs(e[a]-this.activeLayer.y)<=5){this.activeLayer.y=e[a],s=!0;break}s&&this.draw()}var{x:h,y:r}=this.canvasMousePos(t);this.draggingActiveLayer=!1,this.resizingActiveLayer=!1,this.rotatingActiveLayer=!1,this.lastMouseDownOffset={x:0,y:0},this.activeLayerMouseOffset={x:0,y:0},this.activeLayerOriginalDimensions={width:0,height:0},this.activeLayerRotateStartPos={x:0,y:0},this.setCursor(h,r)}getScale(){var t=this.canvas.getBoundingClientRect();return this.canvas.width/t.width}}Canvas.version="1.1.20",Canvas.anchorRadius=8,Canvas.strokeStyle="#ba0000",Canvas.fillStyle="black",Canvas.lineWidth=5,Canvas.cursors={default:null,grab:"grab",grabbing:"grabbing",move:"crosshair",rotate:"grab",rotating:"grabbing"};class CanvasLayer{constructor(t,i,e,s,a=null,h=null,r=0,n=!0,o=!0,c=!0,l=!0,y=!1){this.name=i,this.url=t,this.ready=!1,this.image=null,this.x=e,this.y=s,this.width=a,this.height=h,this.rotation=r,this.draggable=n,this.rotateable=o,this.resizable=c,this.selectable=l,this.forceBoundary=y,this.load_cb_stack=[],this.load()}onload(t){this.ready?t():this.load_cb_stack.push(t)}load(){return new Promise(t=>{if(this.ready)t();else{const t=new Image;t.onload=(()=>{this.image=t,null===this.width&&(this.width=t.width),null===this.height&&(this.height=t.height),this.ready=!0,this.load_cb_stack.forEach(t=>t()),this.load_cb_stack=[]}),t.src=this.url}})}getCorners(){return[{x:-this.width/2,y:-this.height/2},{x:-this.width/2+this.width,y:-this.height/2},{x:-this.width/2+this.width,y:-this.height/2+this.height},{x:-this.width/2,y:-this.height/2+this.height}]}}